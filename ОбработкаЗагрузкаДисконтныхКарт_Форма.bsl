&НаСервере
Процедура ПриСозданииНаСервере()
	Объект.СтатусОбработки = "Готов к загрузке";
	Объект.КоличествоСтрок = 0;
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьФайл(Команда)
	ДиалогВыбора = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	ДиалогВыбора.Фильтр = "Excel файлы (*.xlsx;*.xls)|*.xlsx;*.xls";
	
	Если ДиалогВыбора.Выбрать() Тогда
		Объект.ПутьКФайлу = ДиалогВыбора.ПолноеИмяФайла;
		Объект.СтатусОбработки = "Файл выбран: " + Объект.ПутьКФайлу;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьДанные(Команда)
	Если ПустаяСтрока(Объект.ПутьКФайлу) Тогда
		ПоказатьПредупреждение(, "Выберите файл Excel для загрузки!");
		Возврат;
	КонецЕсли;
	
	Попытка
		ЗагрузитьДанныеНаСервере();
	Исключение
		ПоказатьОшибку(ОписаниеОшибки());
	КонецПопытки;
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьДанныеНаСервере()
	Объект.СтатусОбработки = "Начинаю загрузку...";
	
	// Создаем COM объект для работы с Excel
	Excel = Новый COMОбъект("Excel.Application");
	Excel.Visible = Ложь;
	Excel.DisplayAlerts = Ложь;
	
	Попытка
		// Открываем файл
		РабочаяКнига = Excel.Workbooks.Open(Объект.ПутьКФайлу);
		Лист = РабочаяКнига.Worksheets(1);
		
		// Находим последнюю строку с данными
		ПоследняяСтрока = Лист.Cells.SpecialCells(11).Row;
		
		// Счетчики для статистики
		КоличествоСоздано = 0;
		КоличествоОшибок = 0;
		
		// Обрабатываем строки начиная со второй (первая - заголовки)
		Для Строка = 2 По ПоследняяСтрока Цикл
			Попытка
				// Читаем данные из колонок
				НомерКарты = СокрЛП(Строка(Лист.Cells(Строка, 1).Value));
				Телефон = СокрЛП(Строка(Лист.Cells(Строка, 2).Value));
				ФИОВладельца = СокрЛП(Строка(Лист.Cells(Строка, 3).Value));
				Штрихкод = СокрЛП(Строка(Лист.Cells(Строка, 4).Value));
				ВидСкидки = СокрЛП(Строка(Лист.Cells(Строка, 5).Value));
				
				// Проверяем обязательные поля
				Если ПустаяСтрока(НомерКарты) Или ПустаяСтрока(ФИОВладельца) Тогда
					КоличествоОшибок = КоличествоОшибок + 1;
					Продолжить;
				КонецЕсли;
				
				// Создаем или обновляем запись в справочнике дисконтных карт
				СоздатьДисконтнуюКарту(НомерКарты, Телефон, ФИОВладельца, Штрихкод, ВидСкидки);
				КоличествоСоздано = КоличествоСоздано + 1;
				
			Исключение
				КоличествоОшибок = КоличествоОшибок + 1;
			КонецПопытки;
		КонецЦикла;
		
		// Закрываем Excel
		РабочаяКнига.Close();
		Excel.Quit();
		
		// Обновляем статус
		Объект.КоличествоСтрок = КоличествоСоздано;
		Объект.СтатусОбработки = "Загрузка завершена. Создано: " + КоличествоСоздано + 
			", Ошибок: " + КоличествоОшибок;
		
	Исключение
		// Закрываем Excel в случае ошибки
		Если Excel <> Неопределено Тогда
			Excel.Quit();
		КонецЕсли;
		ВызватьИсключение;
	КонецПопытки;
КонецПроцедуры

&НаСервере
Процедура СоздатьДисконтнуюКарту(НомерКарты, Телефон, ФИОВладельца, Штрихкод, ВидСкидки)
	// Ищем или создаем контрагента
	Контрагент = НайтиИлиСоздатьКонтрагента(ФИОВладельца, Телефон);
	
	// Ищем или создаем вид дисконтной карты
	ВидКарты = НайтиИлиСоздатьВидДисконтнойКарты(ВидСкидки);
	
	// Ищем существующую карту по штрихкоду
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ДисконтныеКарты.Ссылка
	|ИЗ
	|	Справочник.ДисконтныеКарты КАК ДисконтныеКарты
	|ГДЕ
	|	ДисконтныеКарты.КодКартыШтрихкод = &Штрихкод";
	
	Запрос.УстановитьПараметр("Штрихкод", Штрихкод);
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		// Создаем новую карту
		НоваяКарта = Справочники.ДисконтныеКарты.СоздатьЭлемент();
	Иначе
		// Обновляем существующую карту
		НоваяКарта = РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("Ссылка")[0];
	КонецЕсли;
	
	// Заполняем данные
	НоваяКарта.Наименование = НомерКарты;
	НоваяКарта.КодКартыШтрихкод = Штрихкод;
	НоваяКарта.ВладелецКарты = Контрагент;
	НоваяКарта.ВидДисконтнойКарты = ВидКарты;
	
	// Записываем
	НоваяКарта.Записать();
КонецПроцедуры

&НаСервере
Функция НайтиИлиСоздатьКонтрагента(ФИОВладельца, Телефон)
	// Ищем контрагента по ФИО
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	Контрагенты.Ссылка
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|ГДЕ
	|	Контрагенты.Наименование = &ФИОВладельца";
	
	Запрос.УстановитьПараметр("ФИОВладельца", ФИОВладельца);
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		// Создаем нового контрагента
		НовыйКонтрагент = Справочники.Контрагенты.СоздатьЭлемент();
		НовыйКонтрагент.Наименование = ФИОВладельца;
		НовыйКонтрагент.Телефон = Телефон;
		НовыйКонтрагент.Записать();
		Возврат НовыйКонтрагент;
	Иначе
		// Возвращаем найденного контрагента
		Возврат РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("Ссылка")[0];
	КонецЕсли;
КонецФункции

&НаСервере
Функция НайтиИлиСоздатьВидДисконтнойКарты(ВидСкидки)
	// Ищем вид карты по наименованию
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ВидыДисконтныхКарт.Ссылка
	|ИЗ
	|	Справочник.ВидыДисконтныхКарт КАК ВидыДисконтныхКарт
	|ГДЕ
	|	ВидыДисконтныхКарт.Наименование = &ВидСкидки";
	
	Запрос.УстановитьПараметр("ВидСкидки", ВидСкидки);
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		// Создаем новый вид карты
		НовыйВид = Справочники.ВидыДисконтныхКарт.СоздатьЭлемент();
		НовыйВид.Наименование = ВидСкидки;
		НовыйВид.Записать();
		Возврат НовыйВид;
	Иначе
		// Возвращаем найденный вид карты
		Возврат РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("Ссылка")[0];
	КонецЕсли;
КонецФункции 